---
title: "GEE Modeling"
author: "Luke W. Johnston"
date: "`r Sys.Date()`"
output: 
    rmarkdown::html_vignette:
        toc: true
vignette: >
  %\VignetteIndexEntry{GEE Modeling}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Set up and load dataset

```{r setup, message = TRUE, collapse=TRUE}
## Setup
devtools::load_all()
knitr::opts_chunk$set(collapse = TRUE, fig.width = 7, fig.height = 7)
library(dplyr)

## Variable prep
covar_nowaist <- covariates[which(!grepl("Waist", covariates))]
covar_withtag <- c(covariates, "TAG")

## Data prep
gee_results_unadj <- gee_results %>%
    dplyr::filter(model == "Unadjusted")

gee_results_adj <- gee_results %>%
    dplyr::filter(model == "Adjusted")

## Functions
table_gee_sample <- function(data, caption = NULL) {
    data %>%
        select(Yterms, Xterms, sample.total) %>%
        group_by(Yterms) %>%
        summarise(MinSample = min(sample.total),
                  MaxSample = max(sample.total)) %>% 
        knitr::kable(caption = caption)
}

table_gee_int <- function(data, caption = NULL) {
    data %>% 
        filter(p.value <= 0.05) %>% 
        select(Yterms, Xterms, estimate, matches("value"), unit, model, sample.total) %>% 
        knitr::kable()
}
```

# Unadjusted GEE model

```{r tab_gee_results_unadj_sample}
gee_results_unadj %>% 
    table_gee_sample("Working sample size for unadjusted models")
```

```{r fig_gee_results_unadj}
gee_results_unadj %>% 
    plot_gee_main()
```

# Adjusted (as per final model)

```{r tab_gee_results_adj_sample}
gee_results_adj %>% 
    table_gee_sample('Working sample size for adjusted with TAG and others')
```

```{r fig_gee_results_adj}
gee_results_adj %>% 
    plot_gee_main()
```

# Adjusted with TAG

```{r gee_results_tag, cache=TRUE}
gee_results_tag <- bind_rows(
    analyze_gee(project_data, outcomes, ne_pct, covar_withtag, 'mol%', mod = "with TAG"),
    analyze_gee(project_data, outcomes, ne_conc, covar_withtag, 'nmol/mL', mod = "with TAG"),
    ) %>% 
    tidy_gee_results()
```

```{r tab_gee_results_adj_tag_sample}
gee_results_tag %>% 
    table_gee_sample('Working sample size for adjusted with TAG and others')
```

```{r fig_gee_results_adj_tag}
gee_results_tag %>% 
    plot_gee_main()
```

# Adjusted without waist

```{r gee_results_nowaist, cache=TRUE}
gee_results_nowaist <- bind_rows(
    analyze_gee(project_data, outcomes, ne_pct, covar_nowaist, 'mol%', mod = "No WC"),
    analyze_gee(project_data, outcomes, ne_conc, covar_nowaist, 'nmol/mL', mod = "No WC"),
    ) %>% 
    tidy_gee_results()
```

```{r tab_gee_results_adj_nowaist_sample}
gee_results_nowaist %>% 
    table_gee_sample('Working sample size for full adjusted without waist.')
```

```{r fig_gee_results_adj_nowaist}
gee_results_nowaist %>% 
    plot_gee_main()
```

# Interactions with time

```{r gee_results_int_time, cache=TRUE}
gee_results_unadj_int_time <- bind_rows(
    analyze_gee(
        project_data,
        outcomes,
        ne_pct,
        "YearsFromBaseline",
        'mol%',
        mod = "Int with time",
        intvar = "YearsFromBaseline"
        ), 
    analyze_gee(
        project_data,
        outcomes,
        ne_conc,
        "YearsFromBaseline",
        'nmol/mL',
        mod = "Int with time",
        intvar = "YearsFromBaseline")
    ) %>% 
    tidy_gee_results()

gee_results_adj_int_time <- bind_rows(
    analyze_gee(
        project_data,
        outcomes,
        ne_pct,
        covariates,
        'mol%',
        mod = "Int with time",
        intvar = "YearsFromBaseline"
        ), 
    analyze_gee(
        project_data,
        outcomes,
        ne_conc,
        covariates,
        'nmol/mL',
        mod = "Int with time",
        intvar = "YearsFromBaseline")
    ) %>% 
    tidy_gee_results()
```

```{r tab_gee_int_time}
gee_results_unadj_int_time %>% 
    table_gee_int("Interactions with time in unadjusted models.")
gee_results_adj_int_time %>% 
    table_gee_int("Interactions with time in fully adjusted models.")
```

# Interactions with sex 

```{r gee_results_int_sex}
gee_results_adj_int_sex <- bind_rows(
    analyze_gee(
        project_data,
        outcomes,
        ne_pct,
        covariates,
        'mol%',
        mod = "Int with sex",
        intvar = "Sex"
        ), 
    analyze_gee(
        project_data,
        outcomes,
        ne_conc,
        covariates,
        'nmol/mL',
        mod = "Int with sex",
        intvar = "Sex")
    ) %>% 
    tidy_gee_results()
```

```{r tab_gee_int_sex}
gee_results_adj_int_sex %>% 
    table_gee_int("Interactions with sex in fully adjusted models.")
```

# Interactions with ethnicity

```{r gee_results_int_ethn}
gee_results_adj_int_ethn <- bind_rows(
    analyze_gee(
        project_data,
        outcomes,
        ne_pct,
        covariates,
        'mol%',
        mod = "Int with ethnicity",
        intvar = "BiEthnicity"
        ), 
    analyze_gee(
        project_data,
        outcomes,
        ne_conc,
        covariates,
        'nmol/mL',
        mod = "Int with ethnicity",
        intvar = "BiEthnicity")
    ) %>% 
    tidy_gee_results()
```

```{r}
gee_results_adj_int_ethn %>% 
    table_gee_int("Interactions with ethnicity in fully adjusted models.")
```

