---
title: "LDA exploration"
author: "Luke W. Johnston"
date: "January 19, 2016"
output: 
    rmarkdown::html_vignette:
        toc: true
---

# Load up packages and data

```{r setup, collapse=TRUE}
knitr::opts_knit$set(root.dir = '../')
knitr::opts_chunk$set(collapse = TRUE, fig.height = 8, fig.width = 10)
```

```{r loadData, message=FALSE}
source('.Rprofile')
suppressMessages(run_setup())
load_data()
dim(ds)
```

# Prepare the data for the LDA

```{r ldaData}
ds.prep <- ds %>%
    select(VN, lISSI2, matches('^ne\\d\\d')) %>% 
    group_by(VN) %>% 
    mutate(BCF = rstatsToolkit::aide.tertile(lISSI2) %>%
               factor(., labels = c('1st tertile', '2nd tertile', '3rd tertile'), ordered = TRUE)) %>%
    select(BCF, everything()) %>% 
    select(-lISSI2) %>% 
    mutate_each(funs(as.numeric(scale(.))), -BCF, -VN) %>%
    ungroup()

df_Dysgly <- ds %>% 
    filter(VN == 0) %>% 
    mutate(Dysgly = factor(IGT + IFG + DM, labels = c('no', 'yes'))) %>% 
    select(Dysgly, matches('^ne\\d\\d')) %>%
    mutate_each(funs(as.numeric(scale(.))), -Dysgly) %>% 
    na.omit()

df_y1 <- ds.prep %>% 
    filter(VN == 0) %>%
    select(-VN) %>% 
    na.omit() %>%
    arrange(BCF)
df_y3 <- ds.prep %>% 
    filter(VN == 1) %>% 
    select(-VN) %>% 
    na.omit() %>% 
    arrange(BCF)
df_y6 <- ds.prep %>% 
    filter(VN == 2) %>% 
    select(-VN) %>% 
    na.omit() %>% 
    arrange(BCF)

# include also the 3-yr and 6-yr data for training/testing.
fit_y1 <- lda(BCF ~ ., data = df_y1)
fit_y3 <- lda(BCF ~ ., data = df_y3)
fit_y6 <- lda(BCF ~ ., data = df_y6)
fit_dg <- lda(Dysgly ~ ., data = df_Dysgly)
# compare with CV lda.
fitcv_y1 <- lda(BCF ~ ., data = df_y1, CV = TRUE)
fitcv_y3 <- lda(BCF ~ ., data = df_y3, CV = TRUE)
fitcv_y6 <- lda(BCF ~ ., data = df_y6, CV = TRUE)
```

```{r testingLDA}
fit.class_y1 <- predict(fit_y1, newdata = df_y1[, -1])$class %>% 
    factor(., ordered = TRUE)
fit.class_y3 <- predict(fit_y3, newdata = df_y3[, -1])$class %>% 
    factor(., ordered = TRUE)
fit.class_y6 <- predict(fit_y6, newdata = df_y6[, -1])$class %>% 
    factor(., ordered = TRUE)

table(fit.class_y1, df_y1[[1]])
table(fitcv_y1$class, df_y1[[1]])

table(fit.class_y3, df_y3[[1]])
table(fitcv_y3$class, df_y3[[1]])

table(fit.class_y6, df_y6[[1]])
table(fitcv_y6$class, df_y6[[1]])

# Amount of participants who were misclassified
table(fit.class_y1, df_y1[[1]]) %>% 
    as.data.frame() %>% 
    filter(fit.class_y1 != Var2) %>% 
    summarize(count = sum(Freq))

# Amount of participants who were correctly classified
table(fit.class_y1, df_y1[[1]]) %>% 
    as.data.frame() %>% 
    filter(fit.class_y1 == Var2) %>% 
    fit.class_y1 <- predict(fit_y1, newdata = df_y1[, -1])$class %>% 
    factor(., ordered = TRUE)summarize(count = sum(Freq))

fit.class_dg <- predict(fit_dg, newdata = df_Dysgly[, -1])$class %>% 
    factor(., ordered = TRUE)
table(fit.class_dg, df_Dysgly[[1]])
# Not enough sample size for dysglycemia
```

```{r FAperBCF}
seer::visualize(
    fit_y1, 'means', label.rename.fun = function(x)
        x %>%
        gsub('^.*(\\d\\d)(\\d)', '\\1:\\2', .) %>%
        gsub('n(\\d)', 'n-\\1', .)
    ) %>% 
    seer::vision_simple()
seer::visualize(
    fit_y3, 'means', label.rename.fun = function(x)
        x %>%
        gsub('^.*(\\d\\d)(\\d)', '\\1:\\2', .) %>%
        gsub('n(\\d)', 'n-\\1', .)
    ) %>% 
    seer::vision_simple()
seer::visualize(
    fit_y6, 'means', label.rename.fun = function(x)
        x %>%
        gsub('^.*(\\d\\d)(\\d)', '\\1:\\2', .) %>%
        gsub('n(\\d)', 'n-\\1', .)
    ) %>% 
    seer::vision_simple()
```

```{r FAperLD}
seer::visualize(
    fit_y1, 'scaling', label.rename.fun = function(x)
        x %>%
        gsub('^.*(\\d\\d)(\\d)', '\\1:\\2', .) %>%
        gsub('n(\\d)', 'n-\\1', .)
    ) %>% 
    seer::vision_simple()
seer::visualize(
    fit_y3, 'scaling', label.rename.fun = function(x)
        x %>%
        gsub('^.*(\\d\\d)(\\d)', '\\1:\\2', .) %>%
        gsub('n(\\d)', 'n-\\1', .)
    ) %>% 
    seer::vision_simple()
seer::visualize(
    fit_y6, 'scaling', label.rename.fun = function(x)
        x %>%
        gsub('^.*(\\d\\d)(\\d)', '\\1:\\2', .) %>%
        gsub('n(\\d)', 'n-\\1', .)
    ) %>% 
    seer::vision_simple()
```

```{r LDbyBCF}
seer::visualize(fit_y1, orig.data = df_y1, group.name = 'BCF') %>% 
    seer::vision_simple()
seer::visualize(fit_y3, orig.data = df_y3, group.name = 'BCF') %>% 
    seer::vision_simple()
seer::visualize(fit_y6, orig.data = df_y6, group.name = 'BCF') %>% 
    seer::vision_simple()
```
